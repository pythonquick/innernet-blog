
<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="http://localhost:8000/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="http://localhost:8000/theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="http://localhost:8000/theme/font-awesome/css/font-awesome.min.css">





  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />


<meta name="author" content="Guenther" />
<meta name="description" content="The lesson covers some aspects of closures and some gotchas. For an introduction about the concept of closures, see the past lesson notes on closure functions This lesson looks at some common gotchas when dealing with closures and the scope of variables. The main ideas to remember from the last ..." />
<meta name="keywords" content="JavaScript, ES5">
<meta property="og:site_name" content="innernet"/>
<meta property="og:title" content="Closures Revisited"/>
<meta property="og:description" content="The lesson covers some aspects of closures and some gotchas. For an introduction about the concept of closures, see the past lesson notes on closure functions This lesson looks at some common gotchas when dealing with closures and the scope of variables. The main ideas to remember from the last ..."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://localhost:8000/closures-revisited.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2016-07-20 00:00:00-04:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="http://localhost:8000/author/guenther.html">
<meta property="article:section" content="Tutorials"/>
<meta property="article:tag" content="JavaScript"/>
<meta property="article:tag" content="ES5"/>
<meta property="og:image" content="http://s.gravatar.com/avatar/fcfe36f97f3eb56b69ecce65d0c895dc?s=80">

  <title>innernet &ndash; Closures Revisited</title>
</head>
<body>
  <aside>
    <div>
      <a href="http://localhost:8000">
        <img src="http://s.gravatar.com/avatar/fcfe36f97f3eb56b69ecce65d0c895dc?s=80" alt="" title="">
      </a>
      <h1><a href="http://localhost:8000"></a></h1>


      <nav>
        <ul class="list">
          <li><a href="http://localhost:8000/pages/about.html#about">About</a></li>

        </ul>
      </nav>

      <ul class="social">
        <li><a class="sc-You can add links in your config file" href="#" target="_blank"><i class="fa fa-You can add links in your config file"></i></a></li>
        <li><a class="sc-Another social link" href="#" target="_blank"><i class="fa fa-Another social link"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="http://localhost:8000">    Home
</a>

      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>
      <a href="/archives.html">Archives</a>


    </nav>

<article class="single">
  <header>
    <h1 id="closures-revisited">Closures Revisited</h1>
    <p>
          Posted on Wed 20 July 2016 in <a href="http://localhost:8000/category/tutorials.html">Tutorials</a>


    </p>
  </header>
  <div>
    <p>The lesson covers some aspects of closures and some gotchas. 
For an introduction about the concept of closures, see the past lesson notes on <a href="https://innernet.io/es5-closure-functions.html">closure functions</a></p>
<p>This lesson looks at some common gotchas when dealing with closures and the scope of variables. The main ideas to remember from the last closures lesson is:</p>
<ul>
<li>Locally declared variables within a function (where the <code>var</code> keyword is used), will be recycled by the JavaScript engine when the function completes. That means, the memory for those variables will be released and those variables will no longer be available.</li>
<li>The exception to this rule is when the function creates another function that accesses the locally declared variables of its outer parent function. The inner function "closes over" the variables declared by its outer function. Those referenced variables will have to stay around for as long as the inner function is referenced.</li>
</ul>
<h1>Common closures loop bug</h1>
<p>This section looks at a subtle bug that can arise when closure functions are defined within a for loop. </p>
<p>Consider the following body of a simple HTML page:</p>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span>Here are some buttons:<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">id</span><span class="o">=</span><span class="s">&#39;button-list&#39;</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</pre></div>


<p>Next, the page's JavaScript file initializes the list with three list items as soon as the page loads in the browser:</p>
<div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="nx">initDocument</span><span class="p">);</span>


<span class="kd">function</span> <span class="nx">initDocument</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">buttonList</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#button-list&#39;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">idx</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="nx">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">listItem</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;li&gt;&lt;/li&gt;&#39;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">button</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;button&gt;Button &#39;</span> <span class="o">+</span> <span class="nx">idx</span> <span class="o">+</span> <span class="s1">&#39;&lt;/button&gt;&#39;</span><span class="p">);</span>
        <span class="nx">button</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;You clicked button &#39;</span> <span class="o">+</span> <span class="nx">idx</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">listItem</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">button</span><span class="p">).</span><span class="nx">appendTo</span><span class="p">(</span><span class="nx">buttonList</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>At first sight, one would assume that each button click would display a different alert message, but this is not the case.
Each button click displays the message:</p>
<div class="highlight"><pre><span></span>You clicked button 3
</pre></div>


<p>Why is this?</p>
<p>The click handler-function that's attached to the button references the idx variable from the outer (initDocument) function. The click handler-function is therefore a closure function. In fact, each of the three buttons has a separate closure function and they all reference the same idx variable as illustrated by the following graphic:</p>
<p>!http://media.pma.space/redmine/closures-loop-bug.png!</p>
<p>The problem is that the click handler-function does not capture the current value of the idx variable, it merely references the idx variable which will change as the for loop iterates.</p>
<p>One solution is to call a function that returns a click handler-function that's seeded with the current value of the idx variable:</p>
<div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">makeClickHandler</span><span class="p">(</span><span class="nx">idx</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;You clicked button &#39;</span> <span class="o">+</span> <span class="nx">idx</span><span class="p">);</span>
    <span class="p">};</span>
<span class="p">}</span>


<span class="kd">function</span> <span class="nx">initDocument</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">buttonList</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#button-list&#39;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">idx</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="nx">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">listItem</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;li&gt;&lt;/li&gt;&#39;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">button</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;button&gt;Button &#39;</span> <span class="o">+</span> <span class="nx">idx</span> <span class="o">+</span> <span class="s1">&#39;&lt;/button&gt;&#39;</span><span class="p">);</span>
        <span class="nx">button</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">makeClickHandler</span><span class="p">(</span><span class="nx">idx</span><span class="p">));</span>
        <span class="nx">listItem</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">button</span><span class="p">).</span><span class="nx">appendTo</span><span class="p">(</span><span class="nx">buttonList</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>Each time makeClickHandler gets called, it will return a new function. That returned function is still a closure because it references the idx parameter variable of the makeClickHandler function. But in this case that is a separate copy of the original idx variable and will not change.</p>
<p>Another approach would be to put the entire list item creation into the function instead of merely returning the click-handler:</p>
<div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">makeIndexListItem</span><span class="p">(</span><span class="nx">idx</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">listItem</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;li&gt;&lt;/li&gt;&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">button</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;button&gt;Button &#39;</span> <span class="o">+</span> <span class="nx">idx</span> <span class="o">+</span> <span class="s1">&#39;&lt;/button&gt;&#39;</span><span class="p">);</span>
    <span class="nx">button</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;You clicked button &#39;</span> <span class="o">+</span> <span class="nx">idx</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">listItem</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">button</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">listItem</span><span class="p">;</span>
<span class="p">}</span>


<span class="kd">function</span> <span class="nx">initDocument</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">buttonList</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#button-list&#39;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">idx</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="nx">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">listItem</span> <span class="o">=</span> <span class="nx">makeIndexListItem</span><span class="p">(</span><span class="nx">idx</span><span class="p">);</span>
        <span class="nx">listItem</span><span class="p">.</span><span class="nx">appendTo</span><span class="p">(</span><span class="nx">buttonList</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>This might be a good approach when some other functionality on the page might ant to create new list items - the makeIndexListItem function can then be reused.</p>
<p>Lastly, another way of creating a separate function and seeding it with the current loop iteration's idx variable value, is to use the <code>bind</code> function method to create a new function that will pass the specified idx value as a parameter to the function that gets bound. See the last lesson on function methods: http://redmine.pma.space/projects/js-class/wiki/06-29-2016_Functions_part_2#bind-Create-a-new-wrapping-function.</p>
<div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">initDocument</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">buttonList</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#button-list&#39;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">idx</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="nx">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">listItem</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;li&gt;&lt;/li&gt;&#39;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">button</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;button&gt;Button &#39;</span> <span class="o">+</span> <span class="nx">idx</span> <span class="o">+</span> <span class="s1">&#39;&lt;/button&gt;&#39;</span><span class="p">);</span>
        <span class="nx">button</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">theIndex</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;You clicked button &#39;</span> <span class="o">+</span> <span class="nx">theIndex</span><span class="p">);</span>
        <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">idx</span><span class="p">));</span>
        <span class="nx">listItem</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">button</span><span class="p">).</span><span class="nx">appendTo</span><span class="p">(</span><span class="nx">buttonList</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Note: the new function created by the <code>bind</code> method wraps the function that it was called on - the inner function. It passes the index as the first <code>theIndex</code> parameter. So, what happens to the event parameter when the user clicks the button? The event object gets passed as a parameter to this wrapping function (the function returned by the call to <code>bind</code>), and the event object will then in turn get passed on to the inner function - as its second parameter. Since the inner function does not need the event object, it does not list a parameter variable for it. It only lists the first parameter as <code>theIndex</code>.</p>
<h1>Variable scoping bug</h1>
<p>The following code example was taken from a project, and updated only slightly:</p>
<div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">printRowsToTable</span><span class="p">(</span><span class="nx">coffeeProduct</span><span class="p">,</span> <span class="nx">table</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">tr</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;tr&gt;&lt;/tr&gt;&#39;</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;td&gt;&#39;</span> <span class="o">+</span> <span class="nx">coffeeProduct</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;&lt;/td&gt;&#39;</span><span class="p">).</span><span class="nx">appendTo</span><span class="p">(</span><span class="nx">tr</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">btnDelete</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;button&gt;Delete&lt;/button&gt;&#39;</span><span class="p">);</span>
    <span class="nx">btnDelete</span><span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">coffeeProduct</span><span class="p">,</span> <span class="nx">tr</span><span class="p">){</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;Deleted coffee product: &#39;</span> <span class="o">+</span> <span class="nx">coffeeProduct</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
            <span class="nx">url</span><span class="o">:</span> <span class="nx">SDEFMODDIR</span> <span class="o">+</span> <span class="nx">SDEFMOD</span> <span class="o">+</span> <span class="s2">&quot;?FORMID=A4APICOFFEEPRODUCTDELETE&amp;&quot;</span> <span class="o">+</span> <span class="nx">USESSION</span> <span class="o">+</span> 
            <span class="s2">&quot;&amp;FTYPE=R&amp;INIT=Y&amp;TSESSIONSAVE=NO&amp;KCOFFEEPRODUCT=&quot;</span> <span class="o">+</span> <span class="nx">coffeeProduct</span><span class="p">.</span><span class="nx">id</span>
        <span class="p">});</span>
        <span class="nx">tr</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">buttonCell</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;td&gt;&lt;/td&gt;&#39;</span><span class="p">);</span>
    <span class="nx">btnDelete</span><span class="p">.</span><span class="nx">appendTo</span><span class="p">(</span><span class="nx">buttonCell</span><span class="p">);</span>
    <span class="nx">tr</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">buttonCell</span><span class="p">);</span>
    <span class="nx">table</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">tr</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>Here the delete button's click handler-function will fire as soon as the user clicks the button.
BUT, the AJAX call will not fire. In fact, it will not even reach the AJAX call because the alert statement will run into an exception, saying that name is not an attribute of undefined.
What is the bug?</p>
<p>When the click handler-function gets called, the coffeeProduct variable is undefined. The reason for this is that there is a parameter named coffeeProduct defined in the click function's list of parameters but it is not supplied. When the click function gets called, the browser and jQuery pass only one parameter: the click's event object. All further parameters that the function lists will not be supplied and will therefore be undefined. So in this case, the coffeeProduct parameter name "masks" the outer coffeeProduct parameter.</p>
<p>To fix the scoping bug, simply remove the parameters of the click function (except for the first parameter - the event object), so that the click function can act as a closure function and access the proper variables from its surrounding scope.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="http://localhost:8000/tag/javascript.html">JavaScript</a>
      <a href="http://localhost:8000/tag/es5.html">ES5</a>
    </p>
  </div>



</article>

    <footer>
<p>&copy; Guenther </p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>





<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " innernet ",
  "url" : "http://localhost:8000",
  "image": "http://s.gravatar.com/avatar/fcfe36f97f3eb56b69ecce65d0c895dc?s=80",
  "description": ""
}
</script>
</body>
</html>